#!/usr/bin/env bun
// @bun
import"./speck-ac2ebaf8.js";import{I as D,y as x}from"./paths-x5kskk5z.js";import{existsSync as _,mkdirSync as C,readFileSync as A,writeFileSync as P}from"fs";import Q from"path";function B(q){return{claude:Q.join(q,"CLAUDE.md"),gemini:Q.join(q,"GEMINI.md"),copilot:Q.join(q,".github/agents/copilot-instructions.md"),"cursor-agent":Q.join(q,".cursor/rules/specify-rules.mdc"),qwen:Q.join(q,"QWEN.md"),opencode:Q.join(q,"AGENTS.md"),codex:Q.join(q,"AGENTS.md"),windsurf:Q.join(q,".windsurf/rules/specify-rules.md"),kilocode:Q.join(q,".kilocode/rules/specify-rules.md"),auggie:Q.join(q,".augment/rules/specify-rules.md"),roo:Q.join(q,".roo/rules/specify-rules.md"),codebuddy:Q.join(q,"CODEBUDDY.md"),amp:Q.join(q,"AGENTS.md"),shai:Q.join(q,"SHAI.md"),q:Q.join(q,"AGENTS.md")}}function L(q,H){let z=new RegExp(`^\\*\\*${q}\\*\\*: (.+)$`,"m"),I=H.match(z);if(!I)return"";let J=I[1].trim();if(J==="NEEDS CLARIFICATION"||J==="N/A")return"";return J}function b(q){if(!_(q))console.error(`ERROR: Plan file not found: ${q}`),process.exit(1);let H=A(q,"utf-8"),z=L("Language/Version",H),I=L("Primary Dependencies",H),J=L("Storage",H),K=L("Project Type",H);if(z)console.log(`INFO: Found language: ${z}`);else console.error("WARNING: No language information found in plan");if(I)console.log(`INFO: Found framework: ${I}`);if(J&&J!=="N/A")console.log(`INFO: Found database: ${J}`);if(K)console.log(`INFO: Found project type: ${K}`);return{lang:z,framework:I,db:J,projectType:K}}function S(q,H){let z=[];if(q&&q!=="NEEDS CLARIFICATION")z.push(q);if(H&&H!=="NEEDS CLARIFICATION"&&H!=="N/A")z.push(H);return z.join(" + ")}function R(q){if(q.toLowerCase().includes("web"))return`backend/
frontend/
tests/`;return`src/
tests/`}function T(q){if(q.includes("Python"))return"cd src && pytest && ruff check .";else if(q.includes("Rust"))return"cargo test && cargo clippy";else if(q.includes("JavaScript")||q.includes("TypeScript"))return"npm test && npm run lint";return`# Add commands for ${q}`}function y(q){return`${q}: Follow standard conventions`}function f(q,H,z,I,J,K,U,W){if(!_(H))console.error(`ERROR: Template not found at ${H}`),process.exit(1);console.log("INFO: Creating new agent context file from template...");let G=A(H,"utf-8"),O="",M="";if(K&&U)O=`- ${K} + ${U} (${J})`,M=`- ${J}: Added ${K} + ${U}`;else if(K)O=`- ${K} (${J})`,M=`- ${J}: Added ${K}`;else if(U)O=`- ${U} (${J})`,M=`- ${J}: Added ${U}`;else O=`- (${J})`,M=`- ${J}: Added`;let X=R(W),Y=T(K),Z=y(K);G=G.replace(/\[PROJECT NAME\]/g,z),G=G.replace(/\[DATE\]/g,I),G=G.replace(/\[EXTRACTED FROM ALL PLAN\.MD FILES\]/g,O),G=G.replace(/\[ACTUAL STRUCTURE FROM PLANS\]/g,X),G=G.replace(/\[ONLY COMMANDS FOR ACTIVE TECHNOLOGIES\]/g,Y),G=G.replace(/\[LANGUAGE-SPECIFIC, ONLY FOR LANGUAGES IN USE\]/g,Z),G=G.replace(/\[LAST 3 FEATURES AND WHAT THEY ADDED\]/g,M),P(q,G,"utf-8"),console.log("\u2713 Created new agent context file")}function F(q,H,z,I,J,K){console.log("INFO: Updating existing agent context file...");let U=A(q,"utf-8"),W=U.split(`
`),G=[],O=S(I,J),M=[],X="";if(O&&!U.includes(O))M.push(`- ${O} (${z})`);if(K&&K!=="N/A"&&K!=="NEEDS CLARIFICATION"&&!U.includes(K))M.push(`- ${K} (${z})`);if(O)X=`- ${z}: Added ${O}`;else if(K&&K!=="N/A"&&K!=="NEEDS CLARIFICATION")X=`- ${z}: Added ${K}`;let Y=!1,Z=!1,$=!1,E=!1,j=0;for(let v=0;v<W.length;v++){let V=W[v];if(V==="## Active Technologies"){G.push(V),Y=!0;continue}else if(Y&&V.match(/^##\s/)){if(!$&&M.length>0)G.push(...M),$=!0;G.push(V),Y=!1;continue}else if(Y&&V===""){if(!$&&M.length>0)G.push(...M),$=!0;G.push(V);continue}if(V==="## Recent Changes"){if(G.push(V),X)G.push(X);Z=!0,E=!0;continue}else if(Z&&V.match(/^##\s/)){G.push(V),Z=!1;continue}else if(Z&&V.startsWith("- ")){if(j<2)G.push(V),j++;continue}if(V.match(/\*\*Last updated\*\*:.*\d{4}-\d{2}-\d{2}/))G.push(V.replace(/\d{4}-\d{2}-\d{2}/,H));else G.push(V)}P(q,G.join(`
`),"utf-8"),console.log("\u2713 Updated existing agent context file")}function N(q,H,z,I,J,K,U,W){console.log(`INFO: Updating ${H} context file: ${q}`);let G=Q.basename(z),O=new Date().toISOString().split("T")[0],M=Q.dirname(q);if(!_(M))C(M,{recursive:!0});let X=Q.join(x(),"agent-file-template.md");if(!_(q))f(q,X,G,O,I,J,K,W);else F(q,O,I,J,K,U)}function k(q,H,z,I,J,K,U,W){let G={claude:"Claude Code",gemini:"Gemini CLI",copilot:"GitHub Copilot","cursor-agent":"Cursor IDE",qwen:"Qwen Code",opencode:"opencode",codex:"Codex CLI",windsurf:"Windsurf",kilocode:"Kilo Code",auggie:"Auggie CLI",roo:"Roo Code",codebuddy:"CodeBuddy CLI",amp:"Amp",shai:"SHAI",q:"Amazon Q Developer CLI"};if(!(q in H))console.error(`ERROR: Unknown agent type '${q}'`),console.error("Expected: claude|gemini|copilot|cursor-agent|qwen|opencode|codex|windsurf|kilocode|auggie|roo|amp|shai|q"),process.exit(1);let O=H[q],M=G[q];N(O,M,z,I,J,K,U,W)}function w(q,H,z,I,J,K,U){let W=!1,G=[{key:"claude",name:"Claude Code"},{key:"gemini",name:"Gemini CLI"},{key:"copilot",name:"GitHub Copilot"},{key:"cursor-agent",name:"Cursor IDE"},{key:"qwen",name:"Qwen Code"},{key:"opencode",name:"Codex/opencode"},{key:"windsurf",name:"Windsurf"},{key:"kilocode",name:"Kilo Code"},{key:"auggie",name:"Auggie CLI"},{key:"roo",name:"Roo Code"},{key:"codebuddy",name:"CodeBuddy CLI"},{key:"shai",name:"SHAI"},{key:"q",name:"Amazon Q Developer CLI"}];for(let{key:O,name:M}of G){let X=q[O];if(_(X))N(X,M,H,z,I,J,K,U),W=!0}if(!W)console.log("INFO: No existing agent files found, creating default Claude file..."),N(q.claude,"Claude Code",H,z,I,J,K,U)}function m(q,H,z){if(console.log(""),console.log("INFO: Summary of changes:"),q)console.log(`  - Added language: ${q}`);if(H)console.log(`  - Added framework: ${H}`);if(z&&z!=="N/A")console.log(`  - Added database: ${z}`);console.log(""),console.log("INFO: Usage: update-agent-context [claude|gemini|copilot|cursor-agent|qwen|opencode|codex|windsurf|kilocode|auggie|codebuddy|shai|q]")}async function g(q){let H=q[0]||"",z=await D();if(!z.CURRENT_BRANCH){if(console.error("ERROR: Unable to determine current feature"),z.HAS_GIT==="true")console.log("INFO: Make sure you're on a feature branch");else console.log("INFO: Set SPECIFY_FEATURE environment variable or create a feature first");return 1}if(!_(z.IMPL_PLAN)){if(console.error(`ERROR: No plan.md found at ${z.IMPL_PLAN}`),console.log("INFO: Make sure you're working on a feature with a corresponding spec directory"),z.HAS_GIT!=="true")console.log("INFO: Use: export SPECIFY_FEATURE=your-feature-name or create a new feature first");return 1}console.log(`INFO: === Updating agent context files for feature ${z.CURRENT_BRANCH} ===`);let I=b(z.IMPL_PLAN),J=B(z.REPO_ROOT);if(!H)console.log("INFO: No agent specified, updating all existing agent files..."),w(J,z.REPO_ROOT,z.CURRENT_BRANCH,I.lang,I.framework,I.db,I.projectType);else console.log(`INFO: Updating specific agent: ${H}`),k(H,J,z.REPO_ROOT,z.CURRENT_BRANCH,I.lang,I.framework,I.db,I.projectType);return m(I.lang,I.framework,I.db),console.log("\u2713 Agent context update completed successfully"),0}export{g as main};
